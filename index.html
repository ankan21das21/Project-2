<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rodent BMI Analyzer - Web Serial</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f4f4f9; }
        #data-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .data-display { font-size: 2em; margin: 10px 0; font-weight: bold; }
        .status { margin-top: 15px; padding: 10px; border-radius: 4px; }
        .status.connected { background-color: #d4edda; color: #155724; }
        .status.disconnected { background-color: #f8d7da; color: #721c24; }
        input[type="number"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100px; }
    </style>
</head>
<body>

    <h1>üê≠ Rodent BMI Analyzer</h1>

    <div id="data-container">
        
        <button id="connectButton" onclick="connectSerial()">Connect Arduino</button>
        <div id="statusMessage" class="status disconnected">Disconnected</div>

        ---

        <h2>Measurement Inputs</h2>
        <label for="length">Rodent Naso-Anal Length (cm): </label>
        <input type="number" id="lengthInput" value="10" min="1" step="0.1">

        ---

        <h2>Live Data</h2>
        <p>Raw Weight: <span id="weightDisplay" class="data-display">-- g</span></p>
        
        ---
        
        <h2>BMI Result (Lee Index)</h2>
        <p>Calculated Lee Index: <span id="bmiDisplay" class="data-display">--</span></p>
        <p>Category: <span id="categoryDisplay" style="font-weight: bold;">---</span></p>

        <button id="saveButton" disabled>üíæ Save Data to Cloud/Sheet</button>
    </div>

    <script>
        const connectButton = document.getElementById('connectButton');
        const statusMessage = document.getElementById('statusMessage');
        const weightDisplay = document.getElementById('weightDisplay');
        const bmiDisplay = document.getElementById('bmiDisplay');
        const categoryDisplay = document.getElementById('categoryDisplay');
        const lengthInput = document.getElementById('lengthInput');
        const saveButton = document.getElementById('saveButton');
        let port; // Global variable for the serial port connection

        // --- CORE FUNCTION 1: CONNECT SERIAL ---
        async function connectSerial() {
            if (!('serial' in navigator)) {
                alert('Web Serial API not supported in this browser. Please use Google Chrome or Edge.');
                return;
            }

            try {
                // Request access to the serial port
                port = await navigator.serial.requestPort();
                
                // Set Arduino's baud rate (must match your Arduino sketch)
                const baudRate = 9600; 

                // Open the port
                await port.open({ baudRate });

                statusMessage.textContent = 'Connected';
                statusMessage.className = 'status connected';
                connectButton.textContent = 'Disconnect';
                connectButton.onclick = disconnectSerial; // Change button action

                // Start reading data
                readSerial();

            } catch (error) {
                statusMessage.textContent = `Error: ${error.message}`;
                statusMessage.className = 'status disconnected';
            }
        }

        // --- CORE FUNCTION 2: READ DATA STREAM ---
        async function readSerial() {
            const textDecoder = new TextDecoderStream();
            const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
            const reader = textDecoder.readable.getReader();

            // Loop to read data continuously
            while (true) {
                const { value, done } = await reader.read();
                if (done) {
                    reader.releaseLock();
                    break;
                }
                
                // Process the received line of data
                if (value) {
                    processData(value);
                }
            }
        }

        // --- CORE FUNCTION 3: PROCESS AND CALCULATE ---
        function processData(serialData) {
            // EXPECTED FORMAT FROM ARDUINO: "WEIGHT:24.50"
            const match = serialData.match(/WEIGHT:([0-9.]+)/);
            if (match) {
                const weight = parseFloat(match[1]); // e.g., 24.50
                const length = parseFloat(lengthInput.value); // e.g., 10

                // 1. Display Weight
                weightDisplay.textContent = `${weight.toFixed(2)} g`;
                saveButton.disabled = false; // Enable saving when we have fresh data

                // 2. Calculate BMI (Lee Index)
                // Lee Index Formula (Simplified Example)
                // Actual Lee Index: (Cubic Root of Weight in grams / Naso-Anal Length in cm) x 10000
                if (length > 0) {
                    const leeIndex = (Math.cbrt(weight) / length) * 10000;
                    bmiDisplay.textContent = leeIndex.toFixed(2);
                    setCategory(leeIndex); // Determine LED/Text Category
                }
            }
        }

        // --- CORE FUNCTION 4: CATEGORIZATION AND LED SIMULATION ---
        function setCategory(bmi) {
            // **NOTE:** Adjust these ranges based on your actual rodent data!
            let categoryText = '';
            let color = '';

            if (bmi < 250) {
                categoryText = "Underweight ‚ö†Ô∏è"; // LED 1 ON
                color = 'orange';
            } else if (bmi >= 250 && bmi <= 300) {
                categoryText = "Normal ‚úÖ"; // LED 2 ON
                color = 'green';
            } else if (bmi > 300 && bmi <= 350) {
                categoryText = "Overweight üü°"; // LED 3 ON
                color = 'gold';
            } else {
                categoryText = "Obese ‚ùå"; // LED 4 ON
                color = 'red';
            }
            categoryDisplay.textContent = categoryText;
            categoryDisplay.style.color = color;

            // Optional: Send data back to Arduino to light up the corresponding LED (more complex, not included here)
        }

        // --- CORE FUNCTION 5: DISCONNECT (for the new button action) ---
        async function disconnectSerial() {
            if (port) {
                // Close the port
                await port.close();
                statusMessage.textContent = 'Disconnected';
                statusMessage.className = 'status disconnected';
                connectButton.textContent = 'Connect Arduino';
                connectButton.onclick = connectSerial;
            }
        }
        
        // --- CORE FUNCTION 6: SEND DATA TO CLOUD (Placeholder) ---
        saveButton.addEventListener('click', () => {
             const finalData = {
                timestamp: new Date().toISOString(),
                rodentLength: lengthInput.value,
                weight: parseFloat(weightDisplay.textContent),
                leeIndex: parseFloat(bmiDisplay.textContent),
                category: categoryDisplay.textContent.split(' ')[0]
            };
            
            alert('DATA SENT TO CLOUD:\n' + JSON.stringify(finalData, null, 2));
            // *** üöÄ IMPLEMENT CLOUD API CALL HERE (e.g., Fetch to Firebase/Google Apps Script URL) ***
        });

    </script>
</body>
</html>
